<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –û—Ç–ª–∞–¥–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            margin-right: 10px;
            font-weight: bold;
        }
        .tab.active {
            background: rgba(255, 255, 255, 0.3);
        }
        .tab:last-child {
            margin-right: 0;
        }
        .button {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .order-card, .admin-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .loading {
            text-align: center;
            font-style: italic;
        }
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .hidden {
            display: none;
        }
        .user-select {
            margin-bottom: 20px;
        }
        .user-option {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .user-option:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .user-option.selected {
            background: rgba(81, 207, 102, 0.3);
            border: 2px solid #51cf66;
        }
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        .message.success {
            background: rgba(81, 207, 102, 0.2);
            color: #51cf66;
            border: 2px solid #51cf66;
        }
        .message.error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
        }
        .message.loading {
            background: rgba(116, 164, 255, 0.2);
            color: #74a4ff;
            border: 2px solid #74a4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–û—Ç–ª–∞–¥–∫–∞)</h1>
            <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram WebApp</p>
        </div>

        <div class="section">
            <h2>üë§ –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div class="user-select">
                <div class="user-option" onclick="selectUser('1155907659', '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü.', 'saslord')">
                    <strong>–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω</strong><br>
                    ID: 1155907659 | –ò–º—è: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ü. | Username: saslord
                </div>
                <div class="user-option" onclick="selectUser('123456789', '–ù–æ–≤—ã–π –ê–¥–º–∏–Ω', 'new_admin')">
                    <strong>–û–±—ã—á–Ω—ã–π –∞–¥–º–∏–Ω</strong><br>
                    ID: 123456789 | –ò–º—è: –ù–æ–≤—ã–π –ê–¥–º–∏–Ω | Username: new_admin
                </div>
                <div class="user-option" onclick="selectUser('987654321', '–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'user')">
                    <strong>–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</strong><br>
                    ID: 987654321 | –ò–º—è: –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | Username: user
                </div>
            </div>
            <div id="currentUser" class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
        </div>

        <div class="section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('orders')">üìã –ó–∞–∫–∞–∑—ã</button>
                <button class="tab" onclick="switchTab('admins')">üë• –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</button>
            </div>

            <div id="ordersTab">
                <div style="margin-bottom: 20px;">
                    <button class="button" onclick="loadOrders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑—ã</button>
                    <button class="button" onclick="clearAllOrders()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã</button>
                </div>
                <div id="ordersContent" class="loading">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑—ã" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
            </div>

            <div id="adminsTab" class="hidden">
                <div id="messageContainer"></div>
                <div style="margin-bottom: 20px;">
                    <button class="button" onclick="loadAdmins()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–¥–º–∏–Ω–æ–≤</button>
                    <br><br>
                    <input type="text" id="newAdminId" class="input" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    <input type="text" id="newAdminName" class="input" placeholder="–ò–º—è">
                    <input type="text" id="newAdminUsername" class="input" placeholder="Username">
                    <button class="button" onclick="addAdmin()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞</button>
                </div>
                <div id="adminsContent" class="loading">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –∞–¥–º–∏–Ω–æ–≤" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
            </div>
        </div>
    </div>

    <script>
        const apiUrl = 'https://tma-webapp-store.netlify.app/.netlify/functions/webhook';
        let currentUser = null;

        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message ${type}">${text}</div>`;
            
            // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            if (type !== 'loading') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        function selectUser(id, name, username) {
            currentUser = { id: parseInt(id), first_name: name, username: username };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.querySelectorAll('.user-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            
            document.getElementById('currentUser').innerHTML = 
                `<strong>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${name} (ID: ${id}, @${username})`;
                
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
            checkAdminStatus();
        }

        async function checkAdminStatus() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'check_admin',
                        user: currentUser
                    })
                });
                
                const result = await response.json();
                const statusHtml = `
                    <strong>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${currentUser.first_name} (ID: ${currentUser.id})<br>
                    <strong>–ü—Ä–∞–≤–∞:</strong> ${result.isAdmin ? '‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '‚ùå –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} 
                    ${result.isSuperAdmin ? 'üëë –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω' : ''}
                `;
                document.getElementById('currentUser').innerHTML = statusHtml;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤:', error);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('ordersTab').classList.toggle('hidden', tab !== 'orders');
            document.getElementById('adminsTab').classList.toggle('hidden', tab !== 'admins');
        }

        async function loadOrders() {
            if (!currentUser) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            const content = document.getElementById('ordersContent');
            content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_orders',
                        user: currentUser
                    })
                });
                
                const result = await response.json();
                
                if (result.orders && result.orders.length > 0) {
                    let html = `<h3>üìã –ù–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${result.orders.length}</h3>`;
                    result.orders.forEach(order => {
                        html += `
                            <div class="order-card">
                                <strong>–ó–∞–∫–∞–∑ #${order.id}</strong><br>
                                <strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.user_name} (ID: ${order.user_id})<br>
                                <strong>–°—É–º–º–∞:</strong> ${order.total_price} ‚ÇΩ<br>
                                <strong>–°—Ç–∞—Ç—É—Å:</strong> ${order.status}<br>
                                <strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ${order.platform}<br>
                                <strong>–î–∞—Ç–∞:</strong> ${new Date(order.created_at).toLocaleString('ru')}<br>
                                <strong>–£—Å–ª—É–≥–∏:</strong><br>
                                ${order.services.map(s => `‚Ä¢ ${s.name} - ${s.price} ‚ÇΩ`).join('<br>')}
                            </div>
                        `;
                    });
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="error">üì≠ –ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        async function loadAdmins() {
            if (!currentUser) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            const content = document.getElementById('adminsContent');
            content.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤...</div>';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_admins',
                        user: currentUser
                    })
                });
                
                const result = await response.json();
                
                if (result.admins && result.admins.length > 0) {
                    let html = `<h3>üë• –ù–∞–π–¥–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: ${result.admins.length}</h3>`;
                    result.admins.forEach(admin => {
                        html += `
                            <div class="admin-card">
                                <strong>${admin.name}</strong> ${admin.is_super_admin ? 'üëë' : ''}<br>
                                <strong>ID:</strong> ${admin.user_id}<br>
                                <strong>Username:</strong> @${admin.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}<br>
                                <strong>–î–æ–±–∞–≤–ª–µ–Ω:</strong> ${new Date(admin.created_at).toLocaleString('ru')}<br>
                                <strong>–†–æ–ª—å:</strong> ${admin.is_super_admin ? '–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}
                                ${!admin.is_super_admin ? `<button class="button" onclick="removeAdmin('${admin.user_id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                            </div>
                        `;
                    });
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="error">üë• –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
            } catch (error) {
                content.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        async function addAdmin() {
            if (!currentUser) {
                showMessage('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            const id = document.getElementById('newAdminId').value.trim();
            const name = document.getElementById('newAdminName').value.trim();
            const username = document.getElementById('newAdminUsername').value.trim();
            
            if (!id || !name || !username) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (!/^\d+$/.test(id)) {
                showMessage('ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã', 'error');
                return;
            }
            
            showMessage('–î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...', 'loading');
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'add_admin',
                        user: currentUser,
                        targetUserId: id,
                        targetUserName: name,
                        targetUsername: username
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('newAdminId').value = '';
                    document.getElementById('newAdminName').value = '';
                    document.getElementById('newAdminUsername').value = '';
                    showMessage('‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤
                    setTimeout(() => loadAdmins(), 1000);
                } else {
                    showMessage(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }

        async function removeAdmin(adminId) {
            if (!currentUser) {
                showMessage('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?')) return;
            
            showMessage('–£–¥–∞–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...', 'loading');
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'remove_admin',
                        user: currentUser,
                        targetUserId: adminId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤
                    setTimeout(() => loadAdmins(), 1000);
                } else {
                    showMessage(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }

        async function clearAllOrders() {
            if (!currentUser) {
                showMessage('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–∫–∞–∑—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
            
            showMessage('–£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã...', 'loading');
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'clear_orders',
                        user: currentUser
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
                    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤
                    setTimeout(() => loadOrders(), 1000);
                } else {
                    showMessage(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
